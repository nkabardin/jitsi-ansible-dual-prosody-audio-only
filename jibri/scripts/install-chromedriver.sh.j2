#!/usr/bin/env bash
# Install ChromeDriver matching the installed Chrome version
set -euo pipefail

# Get Chrome version
CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
CHROME_MAJOR=$(echo "$CHROME_VERSION" | cut -d. -f1)

echo "Chrome version: $CHROME_VERSION (major: $CHROME_MAJOR)"

# Get latest ChromeDriver version for this Chrome major version
CHROMEDRIVER_URL="https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR}"
CHROMEDRIVER_VERSION=$(curl -fsSL "$CHROMEDRIVER_URL" 2>/dev/null || echo "")

if [[ -z "$CHROMEDRIVER_VERSION" ]]; then
    echo "Could not get ChromeDriver version for Chrome $CHROME_MAJOR, trying alternative method..."
    CHROMEDRIVER_VERSION=$(curl -fsSL "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_MAJOR}" 2>/dev/null || echo "")
fi

if [[ -z "$CHROMEDRIVER_VERSION" ]]; then
    echo "ERROR: Could not determine ChromeDriver version"
    exit 1
fi

echo "ChromeDriver version: $CHROMEDRIVER_VERSION"

# Download ChromeDriver
DOWNLOAD_URL="https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
echo "Downloading from: $DOWNLOAD_URL"

cd /tmp
rm -f chromedriver-linux64.zip chromedriver

if ! curl -fsSL "$DOWNLOAD_URL" -o chromedriver-linux64.zip; then
    # Try alternative URL format
    DOWNLOAD_URL="https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
    echo "Trying alternative URL: $DOWNLOAD_URL"
    curl -fsSL "$DOWNLOAD_URL" -o chromedriver-linux64.zip
fi

# Extract and install
unzip -q chromedriver-linux64.zip
if [[ -d chromedriver-linux64 ]]; then
    mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
else
    mv chromedriver /usr/local/bin/chromedriver
fi

chmod +x /usr/local/bin/chromedriver

# Verify installation
echo "ChromeDriver installed:"
/usr/local/bin/chromedriver --version

# Clean up
rm -rf /tmp/chromedriver-linux64.zip /tmp/chromedriver-linux64

echo "ChromeDriver installation complete"
